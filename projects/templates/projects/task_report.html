<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport de TÃ¢che : {{ task.description }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @page {
            size: A4 portrait;
            margin: 8mm 6mm 10mm 6mm;
            @bottom-center {
                content: element(footer);
                vertical-align: middle;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            font-size: 10pt;
            line-height: 1.25;
            color: #000;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .report-container { max-width: 100%; padding: 0; }

        /* === BOUTON IMPRIMER (visible Ã  l'Ã©cran) === */
        .print-btn {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 1000;
            background: #0d47a1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .print-btn:hover { background: #1976d2; }

        /* === HEADER === */
        .header {
            text-align: center;
            margin-bottom: 12px;
            page-break-after: avoid;
        }
        .header-logo { height: 60px; margin-bottom: 6px; }
        .header-title { font-size: 18pt; font-weight: bold; color: #0d47a1; margin: 0; }
        .header-subtitle { font-size: 13pt; color: #f57c00; margin: 2px 0 0; font-weight: 600; }

        /* === TABLEAU INFOS === */
        .info-table th {
            background: #e3f2fd;
            font-weight: bold;
            width: 20%;
            padding: 5px 8px;
            color: #0d47a1;
            font-size: 10pt;
        }
        .info-table td { padding: 5px 8px; font-size: 10pt; }

        /* === SECTION PHOTOS === */
        .photo-section h2 {
            font-size: 14pt;
            color: #0d47a1;
            margin: 15px 0 8px;
            font-weight: bold;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
            page-break-inside: avoid;
        }

        .photo-card {
            border: 1.5px solid #0d47a1;
            border-radius: 6px;
            overflow: hidden;
            break-inside: avoid;
        }

        .photo-card img {
            width: 100%;
            height: 220px;
            object-fit: contain;
            background: #f8f9fa;
        }

        .photo-caption {
            background: #e3f2fd;
            padding: 5px 8px;
            font-weight: bold;
            font-size: 9.5pt;
            color: #0d47a1;
            text-align: center;
        }

        .photo-meta {
            padding: 3px 8px 6px;
            font-size: 8.5pt;
            color: #555;
            text-align: center;
        }

        /* === FOOTER BANDEAU === */
        .footer-band {
            background: linear-gradient(90deg, #0d47a1, #1976d2);
            color: white;
            padding: 6px 0;
            text-align: center;
            font-size: 8.5pt;
            font-weight: 500;
        }
        .footer-logo { height: 32px; vertical-align: middle; margin-right: 8px; }
        .footer-text { display: inline; }

        /* === IMPRESSION === */
        @media print {
            .print-btn { display: none !important; }
            .photo-grid { gap: 6px; }
            .photo-card img { height: 210px; }
            body { margin: 0; }
        }

        .page-break { page-break-before: always; }
    </style>
</head>
<body>
    {% load i18n %}

    <button class="print-btn no-print" onclick="window.print()">Imprimer / PDF</button>

    <div class="report-container">

        <div class="header">
            <img src="https://i.imgur.com/LOGO_NG_BASE64.png" alt="NG Logo" class="header-logo">
            <h1 class="header-title">RAPPORT D'EXÃ‰CUTION DE TÃ‚CHE</h1>
            <p class="header-subtitle">{{ task.task_type.name }}</p>
        </div>

        <div class="card mb-3">
            <div class="card-header fw-bold" style="background:#e3f2fd; color:#0d47a1;">
                Informations GÃ©nÃ©rales
            </div>
            <table class="table table-sm info-table mb-0">
                <tr>
                    <th>Projet</th>
                    <td>{{ project.name }} ({{ project.country.code }})</td>
                    <th>Site</th>
                    <td>{{ site.site_id_client }} - {{ site.name }}</td>
                </tr>
                <tr>
                    <th>Client</th>
                    <td>{{ project.client.name|default:"N/A" }}</td>
                    <th>Localisation</th>
                    <td>{{ site.location|default:"N/A" }}</td>
                </tr>
                {# ðŸš¨ CORRECTION CRITIQUE ICI : Affichage du username en cas d'absence du nom complet #}
                <tr>
                    <th>Team Lead</th>
                    <td>
                        {{ site.team_lead.get_full_name|default:site.team_lead.username|default:"N/A" }}
                    </td>
                    <th>AssignÃ© Ã </th>
                    <td>
                        {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                    </td>
                </tr>
                <tr>
                    <th>Statut</th>
                    <td>{{ task.get_status_display }} ({{ task.progress_percentage }}%)</td>
                    <th>Date Limite</th>
                    <td>{{ task.due_date|date:"d M Y" }}</td>
                </tr>
                <tr><th>Description</th><td colspan="3">{{ task.description }}</td></tr>
            </table>
        </div>

        <div class="photo-section">
            <h2>Photos de la TÃ¢che ({{ photos|length }})</h2>

            {% if photos %}
                {% for photo in photos %}
                    
                    {# ðŸ’¡ LOGIQUE SIMPLIFIÃ‰E : DÃ©but d'un nouveau grid toutes les 4 photos #}
                    {% if forloop.counter0|divisibleby:4 %}
                        {% if not forloop.first %}</div>{% endif %} {# Ferme le grid prÃ©cÃ©dent #}
                        <div class="photo-grid"> {# Ouvre un nouveau grid #}
                    {% endif %}

                    <div class="photo-card">
                        <img src="{{ photo.photo.url }}" alt="Photo {{ forloop.counter }}">
                        <div class="photo-caption">Photo {{ forloop.counter }} - {{ photo.caption|default:"Aucune lÃ©gende" }}</div>
                        <div class="photo-meta">
                            {# ðŸš¨ CORRECTION : Affichage du username en cas d'absence du nom complet #}
                            Par {{ photo.uploaded_by.get_full_name|default:photo.uploaded_by.username }}<br>
                            le {{ photo.uploaded_at|date:"d/m/Y Ã  H:i" }}
                        </div>
                    </div>

                    {# ðŸš¨ LOGIQUE DE SAUT DE PAGE : AprÃ¨s la 4Ã¨me, 8Ã¨me, 12Ã¨me photo, etc. #}
                    {% if forloop.counter|divisibleby:4 and not forloop.last %}
                        </div>
                        <div class="page-break"></div>
                    {% endif %}
                {% endfor %}
                
                {# Fermeture finale du dernier grid (important s'il n'y a pas un nombre divisible par 4) #}
                </div> 
            {% else %}
                <div class="alert alert-warning p-2">Aucune photo uploadÃ©e.</div>
            {% endif %}
        </div>

        <div class="footer-band" style="position: running(footer);">
            <img src="https://i.imgur.com/NTCGROUP_FOOTER.png" alt="NTC GROUP" class="footer-logo">
            <span class="footer-text">
                NEW TECH COMPANY GROUP SARL | RCCM: RB/COT/22 B 32632 | IFU: 3202270933624<br>
                contact@ntc-groups.com | www.ntc-groups.com | (+229) 55 05 79 79
            </span>
        </div>

        <footer style="text-align:center; font-size:8pt; color:#666; margin-top:8px;">
            Rapport gÃ©nÃ©rÃ© le {% now "d M Y Ã  H:i" %}
        </footer>
    </div>
</body>
</html>