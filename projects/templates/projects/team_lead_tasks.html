{% extends "core/base.html" %}
{% load static %}

{% block title %}Mes T√¢ches par Site{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">üõ†Ô∏è Mes T√¢ches</h1>
    <div class="d-flex gap-2">
        <form method="get" class="d-flex gap-2">
            <select name="filter" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="active" {% if request.GET.filter == 'active' or not request.GET.filter %}selected{% endif %}>T√¢ches Actives</option>
                <option value="all" {% if request.GET.filter == 'all' %}selected{% endif %}>Toutes les T√¢ches</option>
            </select>
        </form>
        <a href="{% url 'home' %}" class="btn btn-secondary btn-sm">
            <i class="fas fa-home me-1"></i> Retour
        </a>
    </div>
</div>

<p class="text-muted">
    Liste des t√¢ches en cours ou √† faire qui vous sont directement assign√©es ou sur vos sites manag√©s.
</p>

{% if tasks %}
    {% for task in tasks %}
        {% ifchanged task.site %}
            {% if not forloop.first %}
                </ul>
            </div>
            {% endif %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light-warning text-dark d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Site: 
                        <a href="{% url 'projects:site_detail' pk=task.site.pk %}" class="text-decoration-none text-dark fw-bold">
                            {{ task.site.site_id_client }}
                        </a>
                        <small class="ms-3 text-muted">({{ task.site.project.name }} - {{ task.site.project.country.code }})</small>
                    </div>
                    <div>
                        {% if task.site.team_lead == user %}
                            <span class="badge bg-success me-2">Team Lead</span>
                        {% endif %}
                        <a href="{% url 'projects:inspection_create' site_pk=task.site.pk %}" class="btn btn-sm btn-danger me-2">
                            <i class="fas fa-exclamation-triangle me-1"></i> Inspection
                        </a>
                        <a href="{% url 'projects:site_detail' pk=task.site.pk %}" class="btn btn-sm btn-primary me-2">
                            <i class="fas fa-eye me-1"></i> D√©tails Site
                        </a>
                        <a href="{% url 'projects:project_detail' pk=task.site.project.pk %}" class="btn btn-sm btn-info">
                            <i class="fas fa-clipboard-list me-1"></i> Voir Projet
                        </a>
                    </div>
                </div>
                <ul class="list-group list-group-flush">
        {% endifchanged %}
                    <li class="list-group-item d-flex justify-content-between align-items-center {% if task.due_date < today %}bg-light-danger{% endif %}">
                        <div>
                            <a href="{% url 'projects:task_update' pk=task.pk %}" class="text-decoration-none fw-bold text-dark">
                                {{ task.description }} 
                            </a>
                            {% if task.is_paid_relevant %}
                                <span class="badge bg-success ms-2">Paie</span>
                            {% endif %}
                            
                            <small class="text-muted ms-3">
                                Assign√© √†: 
                                {% if task.assigned_to == user %}
                                    <strong>Moi-m√™me</strong>
                                {% else %}
                                    {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                                {% endif %}
                            </small>
                            <br>
                            <small class="text-muted">
                                Statut: <span class="badge 
                                    {% if task.status == 'TO_DO' %}bg-secondary
                                    {% elif task.status == 'IN_PROGRESS' %}bg-primary
                                    {% elif task.status == 'QC_PENDING' %}bg-warning text-dark
                                    {% elif task.status == 'APPROVED' %}bg-success
                                    {% elif task.status == 'REJECTED' %}bg-danger
                                    {% endif %}">
                                    {{ task.get_status_display }}
                                </span>
                                | Progression: <span class="badge bg-info">{{ task.progress_percentage }}%</span>
                            </small>
                        </div>
                        <div class="text-end">
                            {% if task.due_date < today %}
                                <span class="badge bg-danger me-2">EN RETARD</span>
                            {% endif %}
                            <small class="text-muted d-block">Limite: {{ task.due_date|date:"d M Y" }}</small>
                            <a href="{% url 'projects:task_update' pk=task.pk %}" class="btn btn-sm btn-warning mt-1">
                                <i class="fas fa-pencil-alt me-1"></i> MAJ
                            </a>
                        </div>
                    </li>
    {% endfor %}
                </ul>
            </div>
{% else %}
    <div class="alert alert-info text-center py-5">
        <i class="fas fa-info-circle fs-4 text-info"></i>
        <p class="mb-0 mt-2">Aucune t√¢che active trouv√©e.</p>
        <p class="text-muted mt-2">
            Vous n'avez actuellement aucune t√¢che assign√©e et vous n'√™tes pas Team Lead d'aucun site actif.
        </p>
    </div>
{% endif %}

<!-- Debug information -->
<div class="card mt-4">
    <div class="card-header bg-dark text-white">
        Informations de D√©bogage
    </div>
    <div class="card-body">
        <p><strong>Utilisateur:</strong> {{ user.username }}</p>
        <p><strong>Groupes:</strong> {{ user_groups|join:", " }}</p>
        <p><strong>Est Team Lead:</strong> {{ is_team_lead|yesno:"Oui,Non" }}</p>
        <p><strong>Sites manag√©s (dans pays actifs):</strong> {{ sites_managed_count }}</p>
        <p><strong>T√¢ches assign√©es (dans pays actifs):</strong> {{ assigned_tasks_count }}</p>
        <p><strong>T√¢ches actives affich√©es:</strong> {{ tasks.count }}</p>
    </div>
</div>

{% endblock %}
