<!-- templates/projects/task_photo_upload.html -->
{% extends "core/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Ajouter des photos - {{ task.site.site_id_client }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-camera me-2"></i>Ajouter des photos √† la t√¢che
            </h4>
        </div>
        <div class="card-body">
            <!-- Informations sur la t√¢che -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <p class="mb-1"><strong>üìç Site:</strong> {{ task.site.site_id_client }}</p>
                    <p class="mb-1"><strong>üìã Projet:</strong> {{ task.site.project.name }}</p>
                    <p class="mb-1"><strong>üéØ T√¢che:</strong> {{ task.task_type.name }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>üë§ Assign√© √†:</strong> {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}</p>
                    <p class="mb-1"><strong>üìÖ Date limite:</strong> {{ task.due_date|date:"d M Y" }}</p>
                </div>
            </div>

            <!-- Formulaire d'upload -->
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form|crispy }}

                <div class="mb-3">
                    <label for="id_photo" class="form-label">Photos</label>
                    <input type="file" name="photo" class="form-control" multiple id="id_photo">
                    <div id="photoHelp" class="form-text">S√©lectionnez une ou plusieurs photos (Ctrl+clic pour s√©lectionner plusieurs fichiers).</div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-2"></i>Uploader les photos
                    </button>
                    <a href="{% url 'projects:task_update' task.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour √† la t√¢che
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Afficher les photos existantes -->
    {% if task.task_images.all %}
    <div class="card mt-4 shadow">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-images me-2"></i>Photos existantes ({{ task.task_images.count }})
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for photo in task.task_images.all %}
                <div class="col-md-3 mb-3">
                    <div class="card h-100">
                        <img src="{{ photo.photo.url }}" class="card-img-top" alt="{{ photo.caption }}" 
                             style="height: 150px; object-fit: cover; cursor: pointer;" 
                             onclick="openModal('{{ photo.photo.url }}')">
                        <div class="card-body p-2">
                            <small class="text-muted d-block">{{ photo.caption|default:"Sans l√©gende" }}</small>
                            <small class="text-muted d-block">{{ photo.uploaded_at|date:"d M Y H:i" }}</small>
                            <small class="text-muted d-block">Par: {{ photo.uploaded_by.username }}</small>
                            <div class="btn-group w-100 mt-1">
                                <a href="{{ photo.photo.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Voir
                                </a>
                                <a href="{{ photo.photo.url }}" download class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-download me-1"></i>T√©l√©charger
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal pour agrandir les photos -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhoto" src="" alt="" style="max-width: 100%; max-height: 70vh;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function openModal(photoUrl) {
    document.getElementById('modalPhoto').src = photoUrl;
    new bootstrap.Modal(document.getElementById('photoModal')).show();
}
</script>
{% endblock %}