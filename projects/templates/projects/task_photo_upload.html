<!-- templates/projects/task_photo_upload.html -->
{% extends "core/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Ajouter des photos - {{ task.site.site_id_client }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-camera me-2"></i>Ajouter des photos √† la t√¢che
            </h4>
        </div>
        <div class="card-body">
            <!-- Informations sur la t√¢che -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <p class="mb-1"><strong>üìç Site:</strong> {{ task.site.site_id_client }}</p>
                    <p class="mb-1"><strong>üìã Projet:</strong> {{ task.site.project.name }}</p>
                    <p class="mb-1"><strong>üéØ T√¢che:</strong> {{ task.task_type.name }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>üë§ Assign√© √†:</strong>
                        {% if task.assigned_to %}
                            {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                        {% else %}
                            <span class="text-danger">Non assign√©</span>
                        {% endif %}
                    </p>
                    <p class="mb-1"><strong>üìÖ Date limite:</strong> {{ task.due_date|date:"d M Y" }}</p>
                </div>
            </div>

            <!-- Formulaire d'upload -->
            <form method="post" enctype="multipart/form-data" id="photo-upload-form">
                {% csrf_token %}
                {{ form|crispy }}

                <div class="mb-3">
                    <label for="id_photo" class="form-label">Photos</label>
                    <input type="file" name="photo" class="form-control" multiple id="id_photo" accept="image/*">
                    <div id="photoHelp" class="form-text">S√©lectionnez une ou plusieurs photos. Elles seront compress√©es avant l'envoi.</div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success" id="submit-button">
                        <i class="fas fa-upload me-2"></i>Uploader les photos
                    </button>
                    <a href="{% url 'projects:task_update' task.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour √† la t√¢che
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Afficher les photos existantes -->
    {% if task.task_images.all %}
    <div class="card mt-4 shadow">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-images me-2"></i>Photos existantes ({{ task.task_images.count }})
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for photo in task.task_images.all %}
                <div class="col-md-3 mb-3">
                    <div class="card h-100">
                        <img src="{{ photo.photo.url }}" class="card-img-top" alt="{{ photo.caption }}" 
                             style="height: 150px; object-fit: cover; cursor: pointer;" 
                             onclick="openModal('{{ photo.photo.url }}')">
                        <div class="card-body p-2">
                            <small class="text-muted d-block">{{ photo.caption|default:"Sans l√©gende" }}</small>
                            <small class="text-muted d-block">{{ photo.uploaded_at|date:"d M Y H:i" }}</small>
                            <small class="text-muted d-block">Par: 
                                {% if photo.uploaded_by %}
                                    {{ photo.uploaded_by.username }}
                                {% else %}
                                    Utilisateur inconnu
                                {% endif %}
                            </small>
                            <div class="btn-group w-100 mt-1">
                                <a href="{{ photo.photo.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Voir
                                </a>
                                <a href="{{ photo.photo.url }}" download class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-download me-1"></i>T√©l√©charger
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal pour agrandir les photos -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhoto" src="" alt="" style="max-width: 100%; max-height: 70vh;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
<script>
function openModal(photoUrl) {
    document.getElementById('modalPhoto').src = photoUrl;
    new bootstrap.Modal(document.getElementById('photoModal')).show();
}

const photoForm = document.getElementById('photo-upload-form');
const photoInput = document.getElementById('id_photo');
const submitButton = document.getElementById('submit-button');

photoForm.addEventListener('submit', async function(event) {
    event.preventDefault();
    
    // Afficher un indicateur de chargement
    submitButton.disabled = true;
    submitButton.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Compression et envoi...
    `;

    const files = photoInput.files;
    if (!files.length) {
        alert("Veuillez s√©lectionner au moins une photo.");
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-upload me-2"></i>Uploader les photos';
        return;
    }

    const options = {
        maxSizeMB: 1,
        maxWidthOrHeight: 1920,
        useWebWorker: true
    }

    const compressedFiles = [];
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        try {
            console.log(`Compression de l'image ${i + 1}/${files.length}: ${file.name}`);
            const compressedFile = await imageCompression(file, options);
            console.log(`Image compress√©e ${i + 1}:`, compressedFile.size / 1024 / 1024, 'MB');
            // Donner un nom au fichier compress√©
            compressedFiles.push(new File([compressedFile], file.name, { type: compressedFile.type, lastModified: Date.now() }));
        } catch (error) {
            console.error('Erreur de compression:', error);
            alert(`Une erreur est survenue lors de la compression de l'image ${file.name}.`);
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-upload me-2"></i>Uploader les photos';
            return;
        }
    }
    
    // Cr√©er un nouvel objet FormData
    const formData = new FormData();
    
    // Ajouter les autres champs du formulaire
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('caption', document.getElementById('id_caption').value);

    // Ajouter les fichiers compress√©s
    compressedFiles.forEach(file => {
        formData.append('photo', file);
    }
    );

    // Envoyer les donn√©es avec fetch
    try {
        const response = await fetch(photoForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                // Le navigateur d√©finit automatiquement le Content-Type pour FormData
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        if (response.ok) {
            // Rediriger vers la page de succ√®s (ou recharger la page)
            window.location.href = "{% url 'projects:task_update' task.pk %}";
        } else {
            // G√©rer les erreurs serveur
            const errorText = await response.text();
            alert('Erreur serveur: ' + errorText);
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-upload me-2"></i>Uploader les photos';
        }
    } catch (error) {
        console.error('Erreur r√©seau:', error);
        alert('Une erreur r√©seau est survenue.');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-upload me-2"></i>Uploader les photos';
    }
});
</script>
{% endblock %}