{% extends "core/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Demandes de mise à jour de profil</h2>

    {# Section pour les demandes en attente #}
    <h3>Demandes en attente ({{ pending_count }})</h3>
    {% if updates %}
    <div class="table-responsive mb-5">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Employé</th>
                    <th>Date de la demande</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for update in updates %}
                <tr>
                    <td>{{ update.employee.first_name }} {{ update.employee.last_name }}</td>
                    <td>{{ update.created_at|date:"d M Y H:i" }}</td>
                    <td><a href="{% url 'users:profile_update_detail' update.pk %}" class="btn btn-sm btn-info">Voir les détails</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        Aucune demande de mise à jour de profil en attente.
    </div>
    {% endif %}

    {# Section pour l'historique #}
    <h3 class="mt-5 mb-3">Historique des mises à jour</h3>

    {# Formulaire de filtre pour l'historique #}
    <form method="GET" class="row g-3 align-items-end mb-4">
        <div class="col-md-4">
            <label for="id_month" class="form-label">Mois :</label>
            <select name="month" id="id_month" class="form-select">
                <option value="">Tous les mois</option>
                {% for m in months %}
                    <option value="{{ m.value }}" {% if m.value|stringformat:"s" == selected_month %}selected{% endif %}>{{ m.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="id_year" class="form-label">Année :</label>
            <select name="year" id="id_year" class="form-select">
                <option value="">Toutes les années</option>
                {% for y in years %}
                    <option value="{{ y }}" {% if y|stringformat:"s" == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary">Filtrer</button>
            <a href="{% url 'users:profile_update_list' %}" class="btn btn-secondary ms-2">Réinitialiser</a>
        </div>
    </form>

    {% if history %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Employé</th>
                    <th>Statut</th>
                    <th>Date de revue</th>
                    <th>Revu par</th>
                    <th>Commentaires</th>
                </tr>
            </thead>
            <tbody>
                {% for record in history %}
                <tr>
                    <td>{{ record.employee.first_name }} {{ record.employee.last_name }}</td>
                    <td>
                        {% if record.status == 'approved' %}
                            <span class="badge bg-success">Approuvée</span>
                        {% elif record.status == 'rejected' %}
                            <span class="badge bg-danger">Rejetée</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ record.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ record.reviewed_at|date:"d M Y H:i" }}</td>
                    <td>{{ record.reviewed_by.first_name }} {{ record.reviewed_by.last_name }}</td>
                    <td>{{ record.comments|default:"Aucun" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        Aucun historique de mise à jour trouvé avec les filtres appliqués.
    </div>
    {% endif %}

</div>
{% endblock %}
