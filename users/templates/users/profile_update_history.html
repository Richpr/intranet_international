{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Historique des mises à jour de profil" %}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{% trans "Historique des mises à jour de profil" %}</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">{% trans "Filtrer l'historique" %}</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label for="month" class="form-label">{% trans "Mois" %}</label>
                    <select name="month" id="month" class="form-select">
                        <option value="">{% trans "Tous les mois" %}</option>
                        {% for m in months %}
                            <option value="{{ m.value }}" {% if m.value|stringformat:"s" == selected_month %}selected{% endif %}>{{ m.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="year" class="form-label">{% trans "Année" %}</label>
                    <select name="year" id="year" class="form-select">
                        <option value="">{% trans "Toutes les années" %}</option>
                        {% for y in years %}
                            <option value="{{ y }}" {% if y|stringformat:"s" == selected_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">{% trans "Filtrer" %}</button>
                </div>
            </form>
        </div>
    </div>

    {% if history %}
        <div class="table-responsive shadow-sm">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">{% trans "Date de la décision" %}</th>
                        <th scope="col">{% trans "Traité par" %}</th>
                        <th scope="col" class="text-center">{% trans "Statut" %}</th>
                        <th scope="col">{% trans "Commentaires" %}</th> {# New column for comments #}
                        <th scope="col" class="text-end">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in history %}
                        <tr class="clickable-row">
                            <td>{{ item.reviewed_at|date:"d/m/Y à H:i" }}</td>
                            <td>{{ item.reviewed_by.get_full_name|default:"Système" }}</td>
                            <td class="text-center">
                                {% if item.status == 'approved' %}
                                    <span class="badge bg-success">{% trans "Approuvée" %}</span>
                                {% else %}
                                    <span class="badge bg-danger">{% trans "Rejetée" %}</span>
                                {% endif %}
                            </td>
                            <td> {# New cell for comments #}
                                {% if item.comments %}
                                    <span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ item.comments }}">
                                        (i) {% trans "Voir" %}
                                    </span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse-{{ forloop.counter }}">
                                    {% trans "Détails" %}
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" class="p-0" style="border: none;"> {# Colspan adjusted to 5 #}
                                <div class="collapse" id="collapse-{{ forloop.counter }}">
                                    <div class="card card-body bg-light border-0">
                                        {% if item.comments %}
                                            <p class="mb-2"><strong>{% trans "Commentaires du manager :" %}</strong>
                                            <em class="text-muted">{{ item.comments }}</em></p>
                                            <hr>
                                        {% endif %}
                                        
                                        <h6 class="mt-2"><strong>{% trans "Détails de la demande :" %}</strong></h6>
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead class="table-secondary">
                                                <tr>
                                                    <th style="width: 30%;">{% trans "Champ modifié" %}</th>
                                                    <th>{% trans "Nouvelle valeur" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            {% for field, values in item.data.items %}
                                                <tr>
                                                    <td><strong>{{ field|title }}</strong></td>
                                                    <td>{{ values }}</td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% include "includes/pagination.html" %}

    {% else %}
        <div class="alert alert-info text-center" role="alert">
            {% trans "Aucun historique de mise à jour trouvé pour la période sélectionnée." %}
        </div>
    {% endif %}

</div>
{% endblock %}
