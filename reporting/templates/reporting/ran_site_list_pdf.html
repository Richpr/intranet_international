<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rapport RAN</title>
    <style>
        @page { size: A4 landscape; margin: 0.8cm; }
        body { font-family: sans-serif; font-size: 8px; color: #333; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 0.5pt solid #444; padding: 4px 2px; text-align: center; word-wrap: break-word; }
        th { background-color: #343a40; color: white; font-weight: bold; font-size: 7px; }
        .text-start { text-align: left; padding-left: 4px; }
        .bg-blue { background-color: #e7f1ff; }
        .bg-green { background-color: #e6fffa; }
        .fw-bold { font-weight: bold; }
    </style>
</head>
<body>
    <h2 style="text-align: center; margin-bottom: 10px;">RAPPORT DE DÉPLOIEMENT RAN</h2>
    <p style="text-align: right; font-size: 7px;">Généré le : {{ date_today|date:"d/m/Y" }}</p>
    
    <table>
        <thead>
            <tr>
                <th style="width: 15%;">Site Name</th>
                <th style="width: 10%;">Project</th>
                <th style="width: 5%;">Année</th>
                <th style="width: 5%;">Mois</th>
                
                {# CONFIG TECHNIQUE #}
                <th>Radio</th>
                <th>Antenna</th>
                <th>Enclosure</th>
                <th>BB/ML</th>
                
                {# LES TÂCHES #}
                <th class="bg-blue" style="color:black">INST.</th>
                <th class="bg-blue" style="color:black">INTEG.</th>
                <th class="bg-blue" style="color:black">EHS 1</th>
                <th class="bg-blue" style="color:black">EHS 2</th>
                <th class="bg-blue" style="color:black">IMK</th>
                <th class="bg-blue" style="color:black">SRS</th>
                <th class="bg-blue" style="color:black">QA</th>
                <th class="bg-green" style="color:black">ATP</th>
                <th style="width: 12%;">COMMENT</th>
            </tr>
        </thead>
        <tbody>
            {% for site in sites %}
            <tr>
                <td class="text-start fw-bold">{{ site.name }}</td>
                <td>{{ site.project.name }}</td>
                <td>{{ site.start_date|date:"Y" }}</td>
                <td>{{ site.start_date|date:"M" }}</td>
                
                <td>{% for radio in site.radio_configurations.all %}{{ radio.radio_type.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                <td>{{ site.antenna_type.name|default:"-" }}</td>
                <td>{{ site.enclosure_type.name|default:"-" }}</td>
                <td>{{ site.bb_ml.name|default:"-" }}</td>

                {% with site_tasks=site.tasks.all %}
                    <td>{% for t in site_tasks %}{% if "INSTALLATION" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                    <td>{% for t in site_tasks %}{% if "INTEGRATION" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                    <td>{% for t in site_tasks %}{% if "EHS 1" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                    <td>{% for t in site_tasks %}{% if "EHS 2" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                    <td>{% for t in site_tasks %}{% if "IMK" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                    <td>{% for t in site_tasks %}{% if "SRS" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                    <td>{{ site.inspections.first.get_resultat_inspection_display|default:"-" }}</td>
                    <td>{% for t in site_tasks %}{% if "ATP" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                    <td class="text-start">{{ site.comment|default:"-" }}</td>
                {% endwith %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>