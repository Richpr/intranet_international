{% extends "reporting/base.html" %}
{% load static %}

{% block reporting_content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold text-primary">üì° Rapport de D√©ploiement RAN</h5>
        <div class="btn-group">
            <a href="{% url 'reporting:ran_site_list_excel' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline-success">
                <i class="fas fa-file-excel me-1"></i> Excel
            </a>
            <a href="{% url 'reporting:ran_site_list_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline-danger">
                <i class="fas fa-file-pdf me-1"></i> PDF
            </a>
        </div>
    </div>
    
    <div class="card-body">
        <form method="get" class="row g-2 mb-4 align-items-end">
            <div class="col-md-3">
                <label class="small fw-bold">Filtrer par pays :</label>
                <select name="country" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">Tous les pays</option>
                    {% for country in countries %}
                    <option value="{{ country.id }}" {% if country.id|stringformat:"s" == selected_country_id %}selected{% endif %}>
                        {{ country.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold">Filtrer par projet :</label>
                <select name="project" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">Tous les projets</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if project.id|stringformat:"s" == selected_project_id %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold">Ann√©e :</label>
                <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">Ann√©e</option>
                    {% for y in years %}
                    <option value="{{ y }}" {% if y|stringformat:"s" == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold">Mois :</label>
                <select name="month" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">Mois</option>
                    {% for m in months %}
                    <option value="{{ m }}" {% if m|stringformat:"s" == selected_month %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <a href="{% url 'reporting:ran_site_list' %}" class="btn btn-sm btn-secondary w-100">R√©initialiser</a>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-hover align-middle border" style="font-size: 0.7rem;">
                <thead class="table-dark text-center">
                    <tr class="text-nowrap">
                        {# COLONNES INITIALES #}
                        <th class="text-start">Site Name</th>
                        <th>Site Id</th>
                        <th>Pays</th>
                        <th>Departement</th>
                        <th>Commune</th>
                        <th>Site Type</th>
                        <th>Project Name</th>
                        <th>Annee</th>
                        <th>Mois</th>
                        
                        {# CONFIG TECHNIQUE #}
                        <th>Radio Type</th>
                        <th>Antenna Type</th>
                        <th>Enclosure</th>
                        <th>BB/ML</th>
                        
                        {# TES 9 TACHES (INSTALLATION, INTEGRATION, EHS 1, EHS 2, IMK, SRS, QA, ATP, COMMENT) #}
                        <th class="bg-primary text-white">INSTALLATION</th>
                        <th class="bg-primary text-white">INTEGRATION</th>
                        <th class="bg-primary text-white">EHS 1</th>
                        <th class="bg-primary text-white">EHS 2</th>
                        <th class="bg-primary text-white">IMK</th>
                        <th class="bg-primary text-white">SRS</th>
                        <th class="bg-info text-dark">QA</th>
                        <th class="bg-success text-white">ATP</th>
                        <th class="bg-secondary text-white">COMMENT</th>
                    </tr>
                </thead>
                <tbody>
                    {% for site in sites %}
                    <tr class="text-nowrap text-center">
                        <td class="fw-bold text-start">{{ site.name }}</td>
                        <td>{{ site.site_id_client }}</td>
                        <td>{{ site.project.country.code }}</td>
                        <td>{{ site.departement.name|default:"-" }}</td>
                        <td>{{ site.location|default:"-" }}</td>
                        <td>{{ site.site_type.name|default:"-" }}</td>
                        <td>{{ site.project.name }}</td>
                        <td>{{ site.start_date|date:"Y" }}</td>
                        <td>{{ site.start_date|date:"F" }}</td>

                        <td>
                            {% for radio in site.radio_configurations.all %}
                                {{ radio.radio_type.name }}{% if not forloop.last %}, {% endif %}
                            {% empty %}-{% endfor %}
                        </td>
                        <td>{{ site.antenna_type.name|default:"-" }}</td>
                        <td>{{ site.enclosure_type.name|default:"-" }}</td>
                        <td>{{ site.bb_ml.name|default:"-" }}</td>

                        {% with site_tasks=site.tasks.all %}
                            {# TACHES SPECIFIQUES #}
                            <td>{% for t in site_tasks %}{% if "INSTALLATION" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                            <td>{% for t in site_tasks %}{% if "INTEGRATION" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                            <td>{% for t in site_tasks %}{% if "EHS 1" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                            <td>{% for t in site_tasks %}{% if "EHS 2" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                            <td>{% for t in site_tasks %}{% if "IMK" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                            <td>{% for t in site_tasks %}{% if "SRS" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                            
                            {# QA (RESULTAT INSPECTION) #}
                            <td>
                                {% with last_insp=site.inspections.first %}
                                    {% if last_insp %}
                                        <span class="badge {% if last_insp.resultat_inspection == 'FTR' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ last_insp.get_resultat_inspection_display }}
                                        </span>
                                    {% else %}-{% endif %}
                                {% endwith %}
                            </td>

                            <td>{% for t in site_tasks %}{% if "ATP" in t.task_type.name|upper %}{{ t.get_status_display }}{% endif %}{% endfor %}</td>
                            
                            {# COMMENTAIRE #}
                            <td class="text-wrap" style="max-width: 150px;">{{ site.comment|default:"-" }}</td>
                        {% endwith %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="22" class="text-center py-4">Aucun site trouv√©.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}